import React, { useState, useEffect, useMemo, useRef } from 'react';

// --- Estilos Globais ---
const GlobalStyles = () => (
  <style>{`
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
    
    body { font-family: 'Inter', sans-serif; background-color: #f8fafc; }
    
    /* Scrollbar */
    .custom-scroll::-webkit-scrollbar { width: 6px; }
    .custom-scroll::-webkit-scrollbar-track { background: #f1f5f9; }
    .custom-scroll::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
    
    /* Animações */
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    .animate-fade-in { animation: fadeIn 0.3s ease-in; }

    /* Variáveis de Tema (Dinâmicas) */
    :root {
        --primary: #3b82f6; /* Azul padrão fallback */
        --primary-dark: #1d4ed8;
        --primary-light: #eff6ff;
    }

    .bg-primary { background-color: var(--primary) !important; }
    .text-primary { color: var(--primary) !important; }
    .border-primary { border-color: var(--primary) !important; }
    .hover-bg-primary:hover { background-color: var(--primary-dark) !important; }
    
    @media print {
        .no-print { display: none !important; }
        .print-only { display: block !important; }
        body { background-color: white; }
        .shadow-sm, .shadow-lg { box-shadow: none !important; }
        .border { border: 1px solid #ddd !important; }
    }
  `}</style>
);

// --- Helpers ---
const toKg = (qty, unit) => {
    const val = parseFloat(qty) || 0;
    if (unit === 'g' || unit === 'ml') return val / 1000;
    return val;
};

// Função para extrair cor predominante da imagem
const extractColor = (imgSrc) => {
    return new Promise((resolve) => {
        const img = new Image();
        img.src = imgSrc;
        img.crossOrigin = "Anonymous";
        img.onload = () => {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            canvas.width = 1;
            canvas.height = 1;
            ctx.drawImage(img, 0, 0, 1, 1);
            const [r, g, b] = ctx.getImageData(0, 0, 1, 1).data;
            // Escurece um pouco se for muito claro para garantir contraste com texto branco
            resolve(`rgb(${r}, ${g}, ${b})`);
        };
        img.onerror = () => resolve('#3b82f6');
    });
};

// --- Ícones ---
const Icon = ({ name, size = 20, className = "" }) => {
    const icons = {
        ChefHat: <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M6 13.87A4 4 0 0 1 7.41 6a5.11 5.11 0 0 1 1.05-1.54 5 5 0 0 1 7.08 0A5.11 5.11 0 0 1 16.59 6 4 4 0 0 1 18 13.87V21H6Z"/><line x1="6" y1="17" x2="18" y2="17"/></svg>,
        ClipboardList: <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><rect width="8" height="4" x="8" y="2" rx="1" ry="1"/><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"/><path d="M12 11h4"/><path d="M12 16h4"/><path d="M8 11h.01"/><path d="M8 16h.01"/></svg>,
        Activity: <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M22 12h-4l-3 9L9 3l-3 9H2"/></svg>,
        Settings: <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.09a2 2 0 0 1-1-1.74v-.5a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></svg>,
        Plus: <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>,
        Trash2: <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/></svg>,
        Save: <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg>,
        BarChart3: <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><line x1="18" y1="20" x2="18" y2="10"/><line x1="12" y1="20" x2="12" y2="4"/><line x1="6" y1="20" x2="6" y2="14"/></svg>,
        ArrowRight: <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><line x1="5" y1="12" x2="19" y2="12"/><polyline points="12 5 19 12 12 19"/></svg>,
        X: <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M18 6 6 18"/><path d="m6 6 18 18"/></svg>,
        CheckCircle: <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>,
        AlertTriangle: <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>,
        Edit: <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>,
        Calendar: <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><rect width="18" height="18" x="3" y="4" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>,
        Box: <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M21 8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16Z"/><path d="m3.3 7 8.7 5 8.7-5"/><path d="M12 22.08V12"/></svg>,
        Eye: <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z"/><circle cx="12" cy="12" r="3"/></svg>,
        Upload: <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>,
        Image: <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><rect width="18" height="18" x="3" y="3" rx="2" ry="2"/><circle cx="9" cy="9" r="2"/><path d="m21 15-3.086-3.086a2 2 0 0 0-2.828 0L6 21"/></svg>
    };
    return icons[name] || <span className="text-xs">?</span>;
};

// --- Componente SearchableSelect ---
const SearchableSelect = ({ options, value, onChange, placeholder, labelKey = 'label', valueKey = 'value', disabled = false }) => {
    const [isOpen, setIsOpen] = useState(false);
    const [searchTerm, setSearchTerm] = useState('');
    const wrapperRef = useRef(null);

    useEffect(() => {
        const handleClickOutside = (event) => {
            if (wrapperRef.current && !wrapperRef.current.contains(event.target)) setIsOpen(false);
        };
        document.addEventListener("mousedown", handleClickOutside);
        return () => document.removeEventListener("mousedown", handleClickOutside);
    }, []);

    useEffect(() => {
        if (!value) {
            setSearchTerm('');
        } else {
            const selected = options.find(opt => (typeof opt === 'object' ? opt[valueKey] : opt) === value);
            if (selected) {
                setSearchTerm(typeof selected === 'object' ? selected[labelKey] : selected);
            }
        }
    }, [value, options, labelKey, valueKey]);

    const filteredOptions = useMemo(() => {
        if (!searchTerm) return options;
        return options.filter(opt => {
            const label = typeof opt === 'object' ? opt[labelKey] : opt;
            return String(label).toLowerCase().includes(searchTerm.toLowerCase());
        });
    }, [options, searchTerm, labelKey]);

    const handleSelect = (opt) => {
        const val = typeof opt === 'object' ? opt[valueKey] : opt;
        const label = typeof opt === 'object' ? opt[labelKey] : opt;
        onChange(val);
        setSearchTerm(String(label));
        setIsOpen(false);
    };

    return (
        <div className="relative w-full" ref={wrapperRef}>
            <div className="relative">
                <input type="text" className={`w-full p-2 border ${isOpen ? 'border-primary ring-1 ring-blue-500' : 'border-slate-300'} rounded-lg outline-none text-sm bg-white disabled:bg-slate-100 disabled:text-slate-400`} placeholder={placeholder} value={searchTerm} onChange={(e) => { setSearchTerm(e.target.value); setIsOpen(true); if(e.target.value === '') onChange(''); }} onClick={() => !disabled && setIsOpen(true)} disabled={disabled} />
                <div className="absolute right-2 top-2.5 text-slate-400 pointer-events-none"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m6 9 6 6 6-6"/></svg></div>
            </div>
            {isOpen && !disabled && (
                <ul className="absolute z-50 w-full mt-1 bg-white border border-slate-200 rounded-lg shadow-lg max-h-60 overflow-auto custom-scroll">
                    {filteredOptions.length > 0 ? (filteredOptions.map((opt, idx) => {
                        const val = typeof opt === 'object' ? opt[valueKey] : opt;
                        const label = typeof opt === 'object' ? opt[labelKey] : opt;
                        return (<li key={idx} onClick={() => handleSelect(opt)} className={`p-2 text-sm cursor-pointer hover:bg-slate-50 ${val === value ? 'bg-slate-100 text-primary font-medium' : 'text-slate-700'}`}>{String(label)}</li>);
                    })) : (<li className="p-2 text-sm text-slate-400 italic">Nenhuma opção encontrada</li>)}
                </ul>
            )}
        </div>
    );
};

// --- Dados Iniciais ---
const initialRecipes = [
    {
        id: 1,
        name: "Pão Francês Tradicional",
        line: "Padaria",
        sections: { "Massa": { processLossPct: 15, tolerancePct: 10 } },
        ingredients: [
            { id: 1, name: "Farinha de Trigo", qty: 25000, unit: "g", lossPct: 0, section: "Massa" },
            { id: 2, name: "Água Gelada", qty: 15000, unit: "g", lossPct: 0, section: "Massa" },
            { id: 3, name: "Sal Refinado", qty: 500, unit: "g", lossPct: 0, section: "Massa" },
            { id: 4, name: "Fermento Biológico", qty: 800, unit: "g", lossPct: 0, section: "Massa" },
            { id: 5, name: "Melhorador", qty: 250, unit: "g", lossPct: 0, section: "Massa" }
        ]
    }
];

const initialLines = ["Padaria", "Confeitaria", "Salgados", "Cozinha Industrial"];
const initialStages = ["Massa", "Recheio", "Cobertura", "Montagem", "Outros"];

// --- Componente de Gráfico ---
const ControlChart = ({ data, targetYield, stageName, tolerance }) => {
    const safeTolerance = tolerance !== undefined ? tolerance : 10;
    if (!data || data.length < 2) return <div className="h-48 flex items-center justify-center text-slate-400 text-sm bg-slate-50 rounded-lg border border-dashed">Dados insuficientes para gráfico (mínimo 2 registros)</div>;
    const values = data.map(d => d.yieldPct);
    const dates = data.map(d => new Date(d.date));
    const mean = targetYield || 0;
    const upperLimit = mean * (1 + safeTolerance / 100);
    const lowerLimit = mean * (1 - safeTolerance / 100);
    const height = 220, width = 600, padding = 50;
    const maxVal = Math.max(...values, upperLimit) * 1.05;
    const minVal = Math.min(...values, lowerLimit) * 0.95;
    const range = (maxVal - minVal) || 1;
    const getY = (val) => height - padding - ((val - minVal) / range) * (height - (padding * 2));
    const getX = (idx) => padding + (idx / (Math.max(values.length - 1, 1))) * (width - (padding * 2));
    const points = values.map((val, idx) => `${getX(idx)},${getY(val)}`).join(' ');

    return (
        <div className="w-full overflow-x-auto">
            <svg width="100%" height="100%" viewBox={`0 0 ${width} ${height}`} className="bg-white rounded-lg shadow-sm border border-slate-200 min-w-[600px]">
                <rect x={padding} y={padding} width={width - padding * 2} height={height - padding * 2} fill="#f8fafc" />
                <line x1={padding} y1={getY(mean)} x2={width - padding} y2={getY(mean)} stroke="var(--primary)" strokeWidth="2" strokeDasharray="4" />
                <text x={width - padding + 5} y={getY(mean) + 3} className="text-[10px] fill-emerald-600 font-bold">Meta: {mean.toFixed(1)}%</text>
                <line x1={padding} y1={getY(upperLimit)} x2={width - padding} y2={getY(upperLimit)} stroke="#ef4444" strokeWidth="1" strokeDasharray="2" />
                <text x={width - padding + 5} y={getY(upperLimit) + 3} className="text-[10px] fill-red-500">LCS</text>
                <line x1={padding} y1={getY(lowerLimit)} x2={width - padding} y2={getY(lowerLimit)} stroke="#ef4444" strokeWidth="1" strokeDasharray="2" />
                <text x={width - padding + 5} y={getY(lowerLimit) + 3} className="text-[10px] fill-red-500">LCI</text>
                <polyline points={points} fill="none" stroke="#64748b" strokeWidth="2" />
                {values.map((val, idx) => (
                    <g key={idx}>
                        <circle cx={getX(idx)} cy={getY(val)} r="4" fill={val > upperLimit || val < lowerLimit ? "#ef4444" : "#64748b"} stroke="white" strokeWidth="2"><title>{dates[idx].toLocaleDateString()}: {val.toFixed(2)}%</title></circle>
                        { (data.length <= 10 || idx % Math.ceil(data.length/10) === 0) && <text x={getX(idx)} y={height - 15} textAnchor="middle" className="text-[9px] fill-slate-500 font-medium" fontSize="9">{dates[idx].toLocaleDateString(undefined, {day:'2-digit', month:'2-digit'})}</text> }
                    </g>
                ))}
            </svg>
            <div className="text-center text-xs text-slate-500 mt-2">Rendimento Real vs Meta ({mean.toFixed(1)}%)</div>
        </div>
    );
};

// --- Sub-Componentes ---

const Dashboard = ({ setView }) => (
    <div className="space-y-6 animate-fade-in">
        <h2 className="text-2xl font-bold text-slate-800">Painel de Controle</h2>
        <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
            <div onClick={() => setView('production')} className="bg-white p-6 rounded-xl shadow-sm border border-slate-200 cursor-pointer hover:shadow-md transition-shadow group">
                <div className="flex justify-between items-start">
                    <div><p className="text-slate-500 text-sm font-medium">Operacional</p><h3 className="text-lg font-bold text-slate-800 mt-1">Ordens de Produção</h3></div>
                    <div className="p-3 bg-blue-50 text-primary rounded-lg transition-colors"><Icon name="ClipboardList" /></div>
                </div>
            </div>
            <div onClick={() => setView('monitoring')} className="bg-white p-6 rounded-xl shadow-sm border border-slate-200 cursor-pointer hover:shadow-md transition-shadow group">
                <div className="flex justify-between items-start">
                    <div><p className="text-slate-500 text-sm font-medium">Qualidade</p><h3 className="text-lg font-bold text-slate-800 mt-1">Acompanhamento</h3></div>
                    <div className="p-3 bg-purple-50 text-purple-600 rounded-lg transition-colors"><Icon name="Activity" /></div>
                </div>
            </div>
            <div onClick={() => setView('recipes')} className="bg-white p-6 rounded-xl shadow-sm border border-slate-200 cursor-pointer hover:shadow-md transition-shadow group">
                <div className="flex justify-between items-start">
                    <div><p className="text-slate-500 text-sm font-medium">Técnica</p><h3 className="text-lg font-bold text-slate-800 mt-1">Minhas Receitas</h3></div>
                    <div className="p-3 bg-emerald-50 text-emerald-600 rounded-lg transition-colors"><Icon name="ChefHat" /></div>
                </div>
            </div>
            <div onClick={() => setView('settings')} className="bg-white p-6 rounded-xl shadow-sm border border-slate-200 cursor-pointer hover:shadow-md transition-shadow group">
                <div className="flex justify-between items-start">
                    <div><p className="text-slate-500 text-sm font-medium">Sistema</p><h3 className="text-lg font-bold text-slate-800 mt-1">Configurações</h3></div>
                    <div className="p-3 bg-slate-50 text-slate-600 rounded-lg transition-colors"><Icon name="Settings" /></div>
                </div>
            </div>
        </div>
    </div>
);

const SettingsView = ({ lines, setLines, stages, setStages, settings, setSettings, onError, showNotification }) => {
    const [newLine, setNewLine] = useState('');
    const [newStage, setNewStage] = useState('');

    const handleLogoUpload = (e) => {
        const file = e.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onloadend = async () => {
                const logoBase64 = reader.result;
                const color = await extractColor(logoBase64);
                setSettings({ ...settings, logo: logoBase64, themeColor: color });
                showNotification("Logo atualizada e tema ajustado!");
            };
            reader.readAsDataURL(file);
        }
    };

    const addLine = () => { if (!newLine) return; if (lines.includes(newLine)) { onError("Linha já existe"); return; } setLines([...lines, newLine]); setNewLine(''); };
    const removeLine = (l) => setLines(lines.filter(x => x !== l));
    const addStage = () => { if (!newStage) return; if (stages.includes(newStage)) { onError("Etapa já existe"); return; } setStages([...stages, newStage]); setNewStage(''); };
    const removeStage = (s) => setStages(stages.filter(x => x !== s));

    return (
        <div className="space-y-6">
            <div className="bg-white rounded-xl shadow-sm border border-slate-200 p-6">
                <h3 className="text-lg font-bold text-slate-800 mb-4">Personalização da Marca</h3>
                <div className="flex items-center gap-6">
                    <div className="w-24 h-24 rounded-lg border-2 border-dashed border-slate-300 flex items-center justify-center overflow-hidden bg-slate-50 relative group cursor-pointer">
                        {settings.logo ? <img src={settings.logo} className="w-full h-full object-contain" /> : <Icon name="Image" className="text-slate-400" size={32} />}
                        <input type="file" accept="image/*" className="absolute inset-0 opacity-0 cursor-pointer" onChange={handleLogoUpload} />
                        <div className="absolute inset-0 bg-black/50 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity text-white text-xs font-medium">Alterar</div>
                    </div>
                    <div>
                        <p className="text-sm font-medium text-slate-700">Logo da Empresa</p>
                        <p className="text-xs text-slate-500 mt-1">O sistema irá extrair a cor da sua logo<br/>para personalizar o tema.</p>
                        <div className="flex items-center gap-2 mt-3">
                            <span className="text-xs text-slate-500">Cor do Tema:</span>
                            <div className="w-6 h-6 rounded-full border border-slate-200 shadow-sm" style={{ backgroundColor: settings.themeColor }}></div>
                        </div>
                    </div>
                </div>
            </div>

            <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div className="bg-white rounded-xl shadow-sm border border-slate-200 p-6">
                    <h3 className="text-lg font-bold text-slate-800 mb-4">Linhas de Produção</h3>
                    <div className="flex gap-2 mb-4"><input value={newLine} onChange={e => setNewLine(e.target.value)} placeholder="Nova linha..." className="flex-1 p-2 border border-slate-300 rounded-lg text-sm" /><button onClick={addLine} className="bg-primary text-white px-3 rounded-lg"><Icon name="Plus" size={18}/></button></div>
                    <ul className="space-y-2">{lines.map(l => (<li key={l} className="flex justify-between items-center bg-slate-50 p-2 rounded text-sm">{l}<button onClick={() => removeLine(l)} className="text-red-500"><Icon name="Trash2" size={16}/></button></li>))}</ul>
                </div>
                <div className="bg-white rounded-xl shadow-sm border border-slate-200 p-6">
                    <h3 className="text-lg font-bold text-slate-800 mb-4">Etapas da Receita</h3>
                    <div className="flex gap-2 mb-4"><input value={newStage} onChange={e => setNewStage(e.target.value)} placeholder="Nova etapa..." className="flex-1 p-2 border border-slate-300 rounded-lg text-sm" /><button onClick={addStage} className="bg-primary text-white px-3 rounded-lg"><Icon name="Plus" size={18}/></button></div>
                    <ul className="space-y-2">{stages.map(s => (<li key={s} className="flex justify-between items-center bg-slate-50 p-2 rounded text-sm">{s}<button onClick={() => removeStage(s)} className="text-red-500"><Icon name="Trash2" size={16}/></button></li>))}</ul>
                </div>
            </div>
        </div>
    );
};

const RecipeList = ({ recipes, lines, onCreate, onEdit, onDelete, onImport }) => {
    const [filterLine, setFilterLine] = useState('');
    const [deleteConfirmId, setDeleteConfirmId] = useState(null);
    const filtered = filterLine ? recipes.filter(r => r.line === filterLine) : recipes;
    const fileInputRef = useRef(null);
    const handleFileChange = (e) => { if (e.target.files && e.target.files[0]) { onImport(e.target.files[0]); e.target.value = null; } };

    return (
        <div className="bg-white rounded-xl shadow-sm border border-slate-200">
            <div className="p-6 border-b border-slate-100 flex flex-col md:flex-row justify-between items-center gap-4">
                <div className="flex-1">
                    <h2 className="text-xl font-bold text-slate-800">Minhas Receitas</h2>
                    <p className="text-xs text-slate-400 mt-1">Gerencie seu catálogo de produtos</p>
                </div>
                <div className="flex gap-2 w-full md:w-auto flex-wrap justify-end">
                    <div className="w-full md:w-48"><SearchableSelect options={[{label: 'Todas as Linhas', value: ''}, ...lines.map(l => ({label: l, value: l}))]} value={filterLine} onChange={setFilterLine} placeholder="Filtrar Linha" /></div>
                    <button onClick={() => fileInputRef.current.click()} className="bg-emerald-600 text-white px-4 py-2 rounded-lg text-sm font-medium hover:bg-emerald-700 flex items-center gap-2"><Icon name="Upload" size={16} /> Importar Excel</button>
                    <input type="file" accept=".xlsx, .xls" ref={fileInputRef} className="hidden" onChange={handleFileChange} />
                    <button onClick={onCreate} className="bg-primary text-white px-4 py-2 rounded-lg text-sm font-medium hover-bg-primary flex items-center gap-2"><Icon name="Plus" size={16} /> Nova Receita</button>
                </div>
            </div>
            <div className="divide-y divide-slate-100">
                {filtered.length === 0 ? <div className="p-8 text-center text-slate-400">Nenhuma receita encontrada.</div> : filtered.map(recipe => (
                    <div key={recipe.id} className="p-4 flex items-center justify-between hover:bg-slate-50 transition-colors group">
                        <div>
                            <h3 className="font-bold text-slate-800">{recipe.name}</h3>
                            <div className="flex gap-2 mt-1">
                                <span className="text-xs bg-slate-100 text-slate-600 px-2 py-0.5 rounded-full border border-slate-200">{recipe.line}</span>
                                <span className="text-xs text-slate-400">{recipe.ingredients.length} Ingredientes</span>
                                {recipe.sections && Object.keys(recipe.sections).map(sec => (<span key={sec} className="text-[10px] bg-blue-50 text-primary px-1.5 py-0.5 rounded border border-blue-100">{sec}</span>))}
                            </div>
                        </div>
                        <div className="flex gap-2 items-center">
                            {deleteConfirmId === recipe.id ? (
                                <div className="flex items-center gap-2 bg-red-50 p-1 rounded-lg border border-red-100">
                                    <span className="text-xs text-red-600 font-medium pl-2">Confirmar?</span>
                                    <button onClick={() => onDelete(recipe.id)} className="px-2 py-1 text-xs bg-red-500 text-white rounded hover:bg-red-600">Sim</button>
                                    <button onClick={() => setDeleteConfirmId(null)} className="px-2 py-1 text-xs text-slate-500 hover:text-slate-700">Não</button>
                                </div>
                            ) : (
                                <div className="flex gap-2 opacity-100 md:opacity-0 group-hover:opacity-100 transition-opacity">
                                    <button onClick={() => onEdit(recipe)} className="p-2 text-primary hover:text-blue-800 rounded-lg">Editar</button>
                                    <button onClick={() => setDeleteConfirmId(recipe.id)} className="p-2 text-red-500 hover:bg-red-50 rounded-lg"><Icon name="Trash2" size={18} /></button>
                                </div>
                            )}
                        </div>
                    </div>
                ))}
            </div>
        </div>
    );
};

const RecipeEditor = ({ recipe, lines, stages, onSave, onCancel, onError }) => {
    const safeRecipe = { ...recipe, ingredients: recipe.ingredients.map(i => ({...i, section: i.section || stages[0]})), sections: recipe.sections || {} };
    const [form, setForm] = useState(safeRecipe);
    const updateField = (field, value) => setForm({ ...form, [field]: value });
    const updateIngredient = (idx, field, value) => { const newIngs = [...form.ingredients]; newIngs[idx][field] = value; setForm({ ...form, ingredients: newIngs }); };
    const addIngredient = (sectionName) => { setForm({ ...form, ingredients: [...form.ingredients, { name: '', qty: 0, unit: 'g', lossPct: 0, section: sectionName }] }); };
    const removeIngredient = (idx) => { const newIngs = form.ingredients.filter((_, i) => i !== idx); setForm({ ...form, ingredients: newIngs }); };
    const updateSectionTolerance = (sectionName, value) => { setForm({ ...form, sections: { ...form.sections, [sectionName]: { ...form.sections?.[sectionName], tolerancePct: value } } }); };

    const calculateSectionData = (sectionName) => {
        const sectionIngs = form.ingredients.filter(i => (i.section || stages[0]) === sectionName);
        const totalInputWeightKg = sectionIngs.reduce((acc, curr) => acc + toKg(curr.qty, curr.unit), 0);
        const lossPct = form.sections?.[sectionName]?.processLossPct || 0;
        const theoreticalYieldKg = totalInputWeightKg * (1 - (lossPct/100));
        return { totalInputWeightKg, theoreticalYieldKg };
    };

    const handleYieldChange = (sectionName, newYieldKg) => {
        const { totalInputWeightKg } = calculateSectionData(sectionName);
        if (totalInputWeightKg === 0) return;
        let newLossPct = ((totalInputWeightKg - newYieldKg) / totalInputWeightKg) * 100;
        if (newLossPct < 0) newLossPct = 0;
        setForm({ ...form, sections: { ...form.sections, [sectionName]: { ...form.sections?.[sectionName], processLossPct: newLossPct } } });
    };

    const activeSections = Array.from(new Set(form.ingredients.map(i => i.section || stages[0])));
    useEffect(() => {
        const newSections = { ...form.sections };
        let changed = false;
        activeSections.forEach(s => { if (!newSections[s]) { newSections[s] = { processLossPct: 0, tolerancePct: 10 }; changed = true; } });
        if (changed) setForm(prev => ({ ...prev, sections: newSections }));
    }, [activeSections.length]);

    const handleSubmit = (e) => {
        e.preventDefault();
        if(!form.name || !form.line) { onError("Preencha o nome da receita e a linha."); return; }
        if(form.ingredients.length === 0) { onError("Adicione pelo menos um ingrediente."); return; }
        onSave(form);
    };

    return (
        <div className="bg-white rounded-xl shadow-lg border border-slate-200 p-6 max-w-4xl mx-auto">
            <h2 className="text-xl font-bold text-slate-800 mb-6">{form.id ? 'Editar Receita' : 'Nova Receita'}</h2>
            <form onSubmit={handleSubmit} className="space-y-6">
                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div><label className="block text-sm font-medium text-slate-700 mb-1">Nome da Receita</label><input required type="text" value={form.name} onChange={e => updateField('name', e.target.value)} className="w-full p-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" placeholder="Ex: Bolo de Chocolate" /></div>
                    <div><label className="block text-sm font-medium text-slate-700 mb-1">Linha de Produção</label><div className="w-full"><SearchableSelect options={lines} value={form.line} onChange={(val) => updateField('line', val)} placeholder="Selecione a Linha" /></div></div>
                </div>
                <div className="space-y-6">
                    {activeSections.map((secName) => {
                        const { totalInputWeightKg, theoreticalYieldKg } = calculateSectionData(secName);
                        return (
                            <div key={secName} className="border border-slate-200 rounded-lg overflow-hidden">
                                <div className="bg-slate-100 p-3 flex justify-between items-center border-b border-slate-200">
                                    <div className="flex items-center gap-3">
                                        <h3 className="font-bold text-slate-700">{secName}</h3>
                                        <div className="flex items-center bg-white px-2 py-1 rounded border border-slate-300"><span className="text-[10px] font-bold text-slate-500 mr-2">Tolerância (+/- %)</span><input type="number" className="w-10 text-xs font-bold text-center outline-none" value={form.sections?.[secName]?.tolerancePct || 10} onChange={(e) => updateSectionTolerance(secName, parseFloat(e.target.value))} /></div>
                                    </div>
                                </div>
                                <div className="p-3 bg-white space-y-3">
                                    <div className="hidden md:flex gap-2 px-1 text-[10px] font-bold text-slate-500 uppercase"><div className="flex-grow">Ingrediente</div><div className="w-24">Qtd (1 un)</div><div className="w-16">Und</div><div className="w-20 text-red-500">Perdas*</div><div className="w-8"></div></div>
                                    {form.ingredients.map((ing, idx) => {
                                        if ((ing.section || stages[0]) !== secName) return null;
                                        return (
                                            <div key={idx} className="flex flex-wrap md:flex-nowrap gap-2 items-center">
                                                <div className="flex-grow w-full md:w-auto"><input required placeholder="Nome do Ingrediente" value={ing.name} onChange={e => updateIngredient(idx, 'name', e.target.value)} className="w-full p-2 bg-slate-50 border border-slate-200 rounded-md text-sm" /></div>
                                                <div className="w-1/2 md:w-24"><input required type="number" step="0.0001" placeholder="Qtd" value={ing.qty} onChange={e => updateIngredient(idx, 'qty', e.target.value)} className="w-full p-2 bg-slate-50 border border-slate-200 rounded-md text-sm" /></div>
                                                <div className="w-1/2 md:w-16"><select value={ing.unit} onChange={e => updateIngredient(idx, 'unit', e.target.value)} className="w-full p-2 bg-slate-50 border border-slate-200 rounded-md text-sm"><option value="g">g</option><option value="kg">kg</option><option value="ml">ml</option><option value="un">un</option></select></div>
                                                <div className="w-full md:w-20 relative"><input type="number" step="0.0001" placeholder="%" value={ing.lossPct} onChange={e => updateIngredient(idx, 'lossPct', e.target.value)} className="w-full p-2 bg-slate-50 border border-slate-200 rounded-md text-sm text-red-500" /></div>
                                                <button type="button" onClick={() => removeIngredient(idx)} className="text-slate-400 hover:text-red-500 p-2"><Icon name="Trash2" size={16} /></button>
                                            </div>
                                        );
                                    })}
                                    <div className="pt-2"><button type="button" onClick={() => addIngredient(secName)} className="text-sm text-white bg-blue-500 px-3 py-1 rounded hover:bg-blue-600 flex items-center gap-1 shadow-sm"><Icon name="Plus" size={14}/> Adicionar Item em {secName}</button></div>
                                </div>
                                <div className="bg-blue-50 p-4 border-t border-blue-100 flex flex-col md:flex-row gap-4 items-center justify-between">
                                    <div className="text-sm text-blue-800"><span className="block text-xs text-blue-500 uppercase font-bold">Peso Total Ingredientes (Entrada)</span><span className="font-bold text-lg">{totalInputWeightKg.toFixed(4)} <small>kg</small></span></div>
                                    <div className="flex items-center gap-2"><Icon name="ArrowRight" className="text-blue-300 hidden md:block" /></div>
                                    <div>
                                        <label className="block text-xs text-blue-500 uppercase font-bold mb-1">Peso Final Teórico (Saída)</label>
                                        <div className="flex items-center gap-2">
                                            <input type="number" step="0.0001" value={parseFloat(theoreticalYieldKg.toFixed(4))} onChange={(e) => handleYieldChange(secName, parseFloat(e.target.value))} className="w-32 p-2 border border-blue-300 rounded-lg text-blue-900 font-bold text-right" /><span className="text-sm text-blue-700">kg</span>
                                        </div>
                                        <p className="text-[10px] text-blue-400 mt-1">Já descontando a perda abaixo</p>
                                    </div>
                                    <div className="text-right"><span className="block text-xs text-red-500 uppercase font-bold">Perda Percentual Calc.</span><span className="font-bold text-lg text-red-600">{(form.sections?.[secName]?.processLossPct || 0).toFixed(2)}%</span></div>
                                </div>
                            </div>
                        );
                    })}
                    {activeSections.length < stages.length && (
                        <div className="bg-slate-50 p-4 rounded-lg border border-dashed border-slate-300 text-center">
                            <p className="text-sm text-slate-500 mb-2">Adicionar nova etapa à receita:</p>
                            <div className="flex justify-center gap-2 flex-wrap">{stages.filter(s => !activeSections.includes(s)).map(s => (<button key={s} type="button" onClick={() => addIngredient(s)} className="text-xs bg-white border border-slate-300 px-3 py-1 rounded-full hover:bg-blue-50 hover:text-blue-600 transition-colors">+ {s}</button>))}</div>
                        </div>
                    )}
                </div>
                <div className="flex justify-end gap-3 pt-4"><button type="button" onClick={onCancel} className="px-6 py-2 text-slate-600 font-medium hover:bg-slate-100 rounded-lg">Cancelar</button><button type="submit" className="px-6 py-2 bg-primary text-white font-medium hover-bg-primary rounded-lg shadow-sm">Salvar Receita</button></div>
            </form>
        </div>
    );
};

const ProductionOrders = ({ recipes, lines, onError }) => {
    const [selectedLine, setSelectedLine] = useState('');
    const [selectedRecipeId, setSelectedRecipeId] = useState('');
    const [mode, setMode] = useState('batch'); 
    const [inputValue, setInputValue] = useState(1);

    const filteredRecipes = useMemo(() => {
        if (!selectedLine) return recipes;
        return recipes.filter(r => r.line === selectedLine);
    }, [recipes, selectedLine]);

    const selectedRecipe = useMemo(() => recipes.find(r => r.id == selectedRecipeId), [recipes, selectedRecipeId]);

    const calculation = useMemo(() => {
        if (!selectedRecipe) return null;
        const ingredientsBySection = {};
        selectedRecipe.ingredients.forEach(ing => {
            const sec = ing.section || "Outros";
            if (!ingredientsBySection[sec]) ingredientsBySection[sec] = [];
            ingredientsBySection[sec].push(ing);
        });

        const sectionsData = {};
        let totalNetYieldKg = 0;

        Object.keys(ingredientsBySection).forEach(secName => {
            const sectionIngs = ingredientsBySection[secName];
            const sectionLossPct = selectedRecipe.sections?.[secName]?.processLossPct || 0;
            const sectionBaseWeightKg = sectionIngs.reduce((acc, curr) => acc + toKg(curr.qty, curr.unit), 0);
            const sectionYieldKg = sectionBaseWeightKg * (1 - (sectionLossPct / 100));
            sectionsData[secName] = { baseWeightKg: sectionBaseWeightKg, yieldKg: sectionYieldKg, lossPct: sectionLossPct, ingredients: sectionIngs };
            totalNetYieldKg += sectionYieldKg;
        });
        
        let factor = 1;
        let targetBatches = 0;
        if (mode === 'batch') { factor = parseFloat(inputValue) || 0; targetBatches = factor; }
        else { const targetKg = (parseFloat(inputValue) || 0); if (totalNetYieldKg > 0) { factor = targetKg / totalNetYieldKg; targetBatches = factor; } else return null; }

        const finalSections = [];
        let grandTotalGrossKg = 0;

        Object.keys(sectionsData).forEach(secName => {
            const data = sectionsData[secName];
            const scaledIngs = data.ingredients.map(ing => {
                const totalReqOriginalUnit = ing.qty * factor;
                const weightInKg = toKg(ing.qty, ing.unit);
                const totalReqKg = weightInKg * factor;
                const cleanLossPct = parseFloat(ing.lossPct) || 0;
                const grossReqKg = cleanLossPct >= 100 ? 0 : totalReqKg / (1 - (cleanLossPct/100));
                return { ...ing, calcNet: totalReqOriginalUnit, calcGrossKg: grossReqKg };
            });
            const sectionTotalGrossKg = scaledIngs.reduce((sum, i) => sum + i.calcGrossKg, 0);
            const sectionFinalWeightKg = data.yieldKg * factor;
            grandTotalGrossKg += sectionTotalGrossKg;
            finalSections.push({ name: secName, processLossPct: data.lossPct, ingredients: scaledIngs, finalWeightKg: sectionFinalWeightKg });
        });
        const finalProductWeightKg = finalSections.reduce((acc, sec) => acc + sec.finalWeightKg, 0);
        return { factor, targetBatches, sections: finalSections, totalGrossKg: grandTotalGrossKg, finalProductWeightKg };
    }, [selectedRecipe, mode, inputValue]);

    return (
        <div className="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
            <div className="p-6 border-b border-slate-100">
                <h2 className="text-xl font-bold text-slate-800 mb-4 flex items-center gap-2"><Icon name="ClipboardList" className="text-primary" /> Gerar Ordem de Produção</h2>
                <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                    <div><label className="block text-sm font-medium text-slate-700 mb-1">Linha de Produção</label><div className="w-full"><SearchableSelect options={[{label: 'Todas as Linhas', value: ''}, ...lines.map(l => ({label: l, value: l}))]} value={selectedLine} onChange={(val) => { setSelectedLine(val); setSelectedRecipeId(''); }} placeholder="Filtrar Linha" /></div></div>
                    <div className="md:col-span-2"><label className="block text-sm font-medium text-slate-700 mb-1">Selecione a Receita</label><div className="w-full"><SearchableSelect options={filteredRecipes.map(r => ({label: r.name, value: r.id}))} value={selectedRecipeId} onChange={setSelectedRecipeId} placeholder="Buscar Receita" disabled={filteredRecipes.length === 0} /></div></div>
                </div>
                {selectedRecipe && (
                    <div className="bg-slate-50 p-4 rounded-lg border border-slate-200">
                        <div className="flex flex-col md:flex-row gap-4 items-end">
                            <div className="flex-1 w-full"><label className="block text-xs uppercase tracking-wider text-slate-500 font-bold mb-2">Meta de Produção</label><div className="flex bg-white rounded-lg p-1 border border-slate-200"><button onClick={() => setMode('batch')} className={`flex-1 py-2 px-4 rounded-md text-sm font-medium transition-colors ${mode === 'batch' ? 'bg-primary text-white shadow-sm' : 'text-slate-500 hover:bg-slate-100'}`}>Por Bateladas</button><button onClick={() => setMode('target')} className={`flex-1 py-2 px-4 rounded-md text-sm font-medium transition-colors ${mode === 'target' ? 'bg-primary text-white shadow-sm' : 'text-slate-500 hover:bg-slate-100'}`}>Por Quantidade (Kg)</button></div></div>
                            <div className="flex-1 w-full"><label className="block text-sm font-medium text-slate-700 mb-1">{mode === 'batch' ? 'Número de Bateladas' : 'Quantidade Final Desejada (Kg)'}</label><input type="number" min="0" step="0.0001" value={inputValue} onChange={(e) => setInputValue(e.target.value)} className="w-full p-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none text-lg font-bold text-slate-800" /></div>
                        </div>
                    </div>
                )}
            </div>
            {calculation && (
                <div className="p-6 bg-slate-50/50">
                    <div className="mb-6 flex flex-wrap gap-4 justify-between items-center bg-white p-4 rounded-lg border border-slate-200 shadow-sm">
                        <div><p className="text-sm text-slate-500">Total Bateladas</p><p className="text-2xl font-bold text-slate-800">{calculation.targetBatches.toFixed(4)}</p></div>
                        <div><p className="text-sm text-slate-500">Total Bruto (Compras)</p><p className="text-2xl font-bold text-slate-800">{calculation.totalGrossKg.toFixed(4)} <span className="text-sm font-normal text-slate-400">kg</span></p></div>
                        <div className="text-right"><p className="text-sm text-emerald-600 font-medium">Produto Final Estimado</p><p className="text-3xl font-bold text-emerald-600">{calculation.finalProductWeightKg.toFixed(4)} <span className="text-lg">kg</span></p></div>
                    </div>
                    <div className="space-y-6">
                        {calculation.sections.map((section, sIdx) => (
                            <div key={sIdx} className="overflow-hidden rounded-lg border border-slate-200 bg-white">
                                <div className="bg-slate-100 px-4 py-2 border-b border-slate-200 flex justify-between items-center"><div className="flex items-center gap-2"><span className="font-bold text-slate-700">{section.name}</span><span className="text-xs bg-white border border-slate-300 px-2 py-0.5 rounded-full text-slate-500">Meta Perda: {section.processLossPct.toFixed(2)}%</span></div><div className="text-xs text-slate-500">Meta Peso Final: <strong>{section.finalWeightKg.toFixed(4)} kg</strong></div></div>
                                <table className="w-full text-left text-sm"><thead className="bg-white text-slate-500 uppercase text-[10px] font-bold border-b border-slate-100"><tr><th className="p-3 w-1/3">Ingrediente</th><th className="p-3 text-right">Qtd Receita</th><th className="p-3 text-right font-bold bg-slate-50">Qtd a Pesar (Bruto)</th></tr></thead><tbody className="divide-y divide-slate-100">{section.ingredients.map((ing, idx) => (<tr key={idx} className="hover:bg-slate-50"><td className="p-3 font-medium text-slate-800">{ing.name}</td><td className="p-3 text-right font-medium text-blue-600">{ing.calcNet.toFixed(4)} <span className="text-[10px] text-slate-400">{ing.unit}</span></td><td className="p-3 text-right font-bold text-slate-800 bg-slate-50">{ing.calcGrossKg.toFixed(4)} <span className="text-[10px] text-slate-400">kg</span></td></tr>))}</tbody></table>
                            </div>
                        ))}
                    </div>
                    <div className="mt-6 flex justify-end gap-3 no-print"><button onClick={() => window.print()} className="px-6 py-3 bg-slate-800 text-white rounded-lg hover:bg-slate-900 shadow-lg flex items-center gap-2 font-bold w-full md:w-auto justify-center"><Icon name="ClipboardList" size={20} /> Imprimir Ordem de Produção</button></div>
                </div>
            )}
        </div>
    );
};

const MonitoringView = ({ recipes, logs, onSaveLog, onError, onUpdateLog, onDeleteLog }) => {
    const [selectedRecipeId, setSelectedRecipeId] = useState('');
    const [selectedStage, setSelectedStage] = useState('');
    const [measuredWeightKg, setMeasuredWeightKg] = useState('');
    const [numBatches, setNumBatches] = useState('1'); 
    const [editingId, setEditingId] = useState(null);
    const [recordDate, setRecordDate] = useState(new Date().toISOString().slice(0, 16));
    const [startDate, setStartDate] = useState('');
    const [endDate, setEndDate] = useState('');

    const selectedRecipe = useMemo(() => recipes.find(r => r.id == selectedRecipeId), [recipes, selectedRecipeId]);
    const availableStages = useMemo(() => { if (!selectedRecipe) return []; return Object.keys(selectedRecipe.sections || {}); }, [selectedRecipe]);
    
    // Cálculo do Rendimento Teórico (Meta)
    // Fórmula: 100% - Perda de Processo Cadastrada
    const targetLossPct = selectedRecipe?.sections?.[selectedStage]?.processLossPct || 0;
    const targetYieldPct = 100 - targetLossPct;
    const targetTolerance = selectedRecipe?.sections?.[selectedStage]?.tolerancePct || 10;

    const handleRegister = (e) => {
        e.preventDefault();
        if (!selectedRecipeId || !selectedStage || !measuredWeightKg || !numBatches || !recordDate) { onError("Preencha todos os campos."); return; }
        const batches = parseFloat(numBatches);
        const output = parseFloat(measuredWeightKg);
        if (batches <= 0) { onError("Número de bateladas inválido."); return; }

        const sectionIngs = selectedRecipe.ingredients.filter(i => (i.section || 'Massa') === selectedStage);
        const baseWeightPerBatch = sectionIngs.reduce((acc, curr) => acc + toKg(curr.qty, curr.unit), 0);
        const theoreticalInput = baseWeightPerBatch * batches;
        if (theoreticalInput <= 0) { onError("Erro: Receita sem peso base nesta etapa."); return; }

        // Rendimento Real (%) = (Peso Obtido / Peso Total Ingredientes) * 100
        const actualYieldPct = (output / theoreticalInput) * 100;

        const logEntry = {
            id: editingId || Date.now(),
            date: recordDate,
            recipeId: selectedRecipeId,
            recipeName: selectedRecipe.name,
            stage: selectedStage,
            batches: batches,
            outputKg: output,
            yieldPct: actualYieldPct,
            targetYieldPct: targetYieldPct
        };

        if (editingId) { onUpdateLog(logEntry); setEditingId(null); } else { onSaveLog(logEntry); }
        setMeasuredWeightKg(''); setNumBatches('1'); setRecordDate(new Date().toISOString().slice(0, 16));
    };

    const handleEdit = (log) => { setSelectedRecipeId(log.recipeId); setSelectedStage(log.stage); setMeasuredWeightKg(log.outputKg); setNumBatches(log.batches || 1); setEditingId(log.id); setRecordDate(log.date.slice(0, 16)); };
    const handleCancelEdit = () => { setEditingId(null); setMeasuredWeightKg(''); setNumBatches('1'); setRecordDate(new Date().toISOString().slice(0, 16)); };
    const handleDelete = (id) => { if (confirm("Tem certeza que deseja excluir este registro?")) onDeleteLog(id); };

    const chartData = useMemo(() => {
        let filtered = logs.filter(l => l.recipeId == selectedRecipeId && l.stage === selectedStage);
        if (startDate) filtered = filtered.filter(l => new Date(l.date) >= new Date(startDate));
        if (endDate) { const end = new Date(endDate); end.setHours(23, 59, 59, 999); filtered = filtered.filter(l => new Date(l.date) <= end); }
        return filtered.sort((a, b) => new Date(a.date) - new Date(b.date)); 
    }, [logs, selectedRecipeId, selectedStage, startDate, endDate]);

    return (
        <div className="space-y-6">
            <div className="bg-white rounded-xl shadow-sm border border-slate-200 p-6">
                <div className="flex justify-between items-center mb-4"><h2 className="text-xl font-bold text-slate-800 flex items-center gap-2"><Icon name="Activity" className="text-primary" /> Monitoramento de Etapas (CEP)</h2></div>
                <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div><label className="block text-sm font-medium text-slate-700 mb-1">Receita</label><div className="w-full"><SearchableSelect options={recipes.map(r => ({label: r.name, value: r.id}))} value={selectedRecipeId} onChange={(val) => { setSelectedRecipeId(val); setSelectedStage(''); }} placeholder="Buscar Receita" disabled={!!editingId} /></div></div>
                    <div><label className="block text-sm font-medium text-slate-700 mb-1">Etapa para Verificar</label><div className="w-full"><SearchableSelect options={availableStages.map(s => ({label: s, value: s}))} value={selectedStage} onChange={setSelectedStage} placeholder="Selecione a Etapa" disabled={!selectedRecipeId || !!editingId} /></div></div>
                </div>
                {selectedStage && (
                    <form onSubmit={handleRegister} className={`mt-6 p-4 rounded-lg border ${editingId ? 'bg-yellow-50 border-yellow-200' : 'bg-blue-50 border-blue-100'}`}>
                        <h3 className={`font-bold mb-3 text-sm ${editingId ? 'text-yellow-800' : 'text-blue-900'}`}>{editingId ? 'Editando Registro' : 'Registrar Novo Ponto'}</h3>
                        <div className="grid grid-cols-1 md:grid-cols-4 gap-4 items-end">
                            <div><label className="block text-xs font-bold mb-1 opacity-70">Data/Hora</label><input type="datetime-local" className="w-full p-2 border border-slate-200 rounded-lg text-sm" value={recordDate} onChange={e => setRecordDate(e.target.value)} /></div>
                            <div><label className="block text-xs font-bold mb-1 opacity-70">Nº de Bateladas</label><input type="number" step="0.1" className="w-full p-2 border border-slate-200 rounded-lg text-sm" value={numBatches} onChange={e => setNumBatches(e.target.value)} /></div>
                            <div><label className="block text-xs font-bold mb-1 opacity-70">Peso Final Real (Saída)</label><div className="flex items-center gap-2"><input type="number" step="0.0001" placeholder="0.0000" className="w-full p-2 border border-slate-200 rounded-lg text-sm" value={measuredWeightKg} onChange={e => setMeasuredWeightKg(e.target.value)} /><span className="text-xs">kg</span></div></div>
                            <div className="flex gap-2"><button type="submit" className={`flex-1 text-white p-2 rounded-lg font-bold text-sm shadow-sm ${editingId ? 'bg-yellow-600 hover:bg-yellow-700' : 'bg-primary hover-bg-primary'}`}>{editingId ? 'Atualizar' : 'Salvar'}</button>{editingId && (<button type="button" onClick={handleCancelEdit} className="bg-slate-200 text-slate-600 p-2 rounded-lg font-bold text-sm hover:bg-slate-300">Cancelar</button>)}</div>
                        </div>
                    </form>
                )}
            </div>
            {selectedStage && (
                <div className="space-y-6 animate-fade-in">
                    <div className="bg-white p-4 rounded-lg shadow-sm border border-slate-200 flex flex-wrap gap-4 items-center">
                        <div className="flex items-center gap-2"><Icon name="Calendar" size={18} className="text-slate-400" /><span className="text-sm font-bold text-slate-700">Filtrar Histórico:</span></div>
                        <div className="flex gap-2"><input type="date" className="p-2 border border-slate-300 rounded text-sm text-slate-600" value={startDate} onChange={(e) => setStartDate(e.target.value)} /><span className="text-slate-400 self-center">até</span><input type="date" className="p-2 border border-slate-300 rounded text-sm text-slate-600" value={endDate} onChange={(e) => setEndDate(e.target.value)} /></div>
                        {(startDate || endDate) && <button onClick={() => { setStartDate(''); setEndDate(''); }} className="text-xs text-blue-500 hover:underline">Limpar</button>}
                    </div>
                    {chartData.length > 0 ? (
                        <>
                            <div className="bg-white rounded-xl shadow-lg border border-slate-200 p-6">
                                <div className="flex justify-between items-center mb-4">
                                    <h3 className="font-bold text-slate-700">Carta de Controle: {selectedStage}</h3>
                                    <div className="text-xs text-slate-500">Meta Teórica: <strong>{targetYieldPct.toFixed(2)}%</strong> (Base: Soma dos Insumos - Perda {targetLossPct.toFixed(2)}%)</div>
                                </div>
                                <ControlChart data={chartData} targetYield={targetYieldPct} stageName={selectedStage} tolerance={targetTolerance} />
                            </div>
                            <div className="bg-white rounded-xl shadow-sm border border-slate-200 p-6">
                                <h3 className="font-bold text-slate-800 mb-4">Histórico Detalhado</h3>
                                <div className="overflow-x-auto">
                                    <table className="w-full text-left text-sm">
                                        <thead className="bg-slate-50 text-slate-500 uppercase text-xs">
                                            <tr><th className="p-3">Data</th><th className="p-3 text-right">Bateladas</th><th className="p-3 text-right">Saída (kg)</th><th className="p-3 text-right font-bold">Rendimento</th><th className="p-3 text-right">Custo (+/-)</th><th className="p-3 text-right">Status</th><th className="p-3 text-right">Ações</th></tr>
                                        </thead>
                                        <tbody className="divide-y divide-slate-100">
                                            {[...chartData].reverse().map(log => {
                                                const deviation = log.yieldPct - log.targetYieldPct;
                                                const isCritical = Math.abs(deviation) > ((log.targetYieldPct * targetTolerance) / 100);
                                                const costImpact = log.yieldPct ? ((log.targetYieldPct / log.yieldPct) - 1) * 100 : 0;
                                                const costColor = costImpact > 0 ? 'text-red-500' : 'text-emerald-500';
                                                return (
                                                    <tr key={log.id} className="hover:bg-slate-50">
                                                        <td className="p-3 text-slate-500 whitespace-nowrap">{new Date(log.date).toLocaleDateString()} {new Date(log.date).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</td>
                                                        <td className="p-3 text-right text-slate-600">{log.batches}</td>
                                                        <td className="p-3 text-right text-slate-800 font-medium">{log.outputKg.toFixed(4)}</td>
                                                        <td className="p-3 text-right font-bold text-blue-600">{log.yieldPct.toFixed(2)}%</td>
                                                        <td className={`p-3 text-right font-medium ${costColor}`}>{costImpact > 0 ? '+' : ''}{costImpact.toFixed(2)}%</td>
                                                        <td className={`p-3 text-right font-medium ${isCritical ? 'text-red-600 font-bold' : 'text-emerald-500'}`}>{isCritical ? 'CRÍTICO' : 'OK'}</td>
                                                        <td className="p-3 text-right flex justify-end gap-2"><button onClick={() => handleEdit(log)} className="text-primary hover:text-blue-800"><Icon name="Edit" size={16}/></button><button onClick={() => handleDelete(log.id)} className="text-red-500 hover:text-red-700"><Icon name="Trash2" size={16}/></button></td>
                                                    </tr>
                                                );
                                            })}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </>
                    ) : (<div className="bg-slate-50 p-8 rounded-lg text-center text-slate-400 border border-dashed">Nenhum dado encontrado para o período selecionado.</div>)}
                </div>
            )}
        </div>
    );
};

// --- Componente Principal (App) ---
export default function App() {
    const [view, setView] = useState('dashboard');
    const [settings, setSettings] = useState(() => {
        const saved = localStorage.getItem('prod_settings');
        return saved ? JSON.parse(saved) : { logo: null, themeColor: '#3b82f6' };
    });
    const [recipes, setRecipes] = useState(() => {
        const saved = localStorage.getItem('prod_recipes');
        return saved ? JSON.parse(saved) : initialRecipes;
    });
    const [lines, setLines] = useState(() => {
        const saved = localStorage.getItem('prod_lines');
        return saved ? JSON.parse(saved) : initialLines;
    });
    const [stages, setStages] = useState(() => {
        const saved = localStorage.getItem('prod_stages');
        return saved ? JSON.parse(saved) : initialStages;
    });
    const [logs, setLogs] = useState(() => {
        const saved = localStorage.getItem('prod_monitoring_logs');
        return saved ? JSON.parse(saved) : [];
    });
    const [editingRecipe, setEditingRecipe] = useState(null);
    const [notification, setNotification] = useState(null);

    // Efeitos de Persistência
    useEffect(() => { localStorage.setItem('prod_settings', JSON.stringify(settings)); }, [settings]);
    useEffect(() => { localStorage.setItem('prod_recipes', JSON.stringify(recipes)); }, [recipes]);
    useEffect(() => { localStorage.setItem('prod_monitoring_logs', JSON.stringify(logs)); }, [logs]);
    useEffect(() => { localStorage.setItem('prod_lines', JSON.stringify(lines)); }, [lines]);
    useEffect(() => { localStorage.setItem('prod_stages', JSON.stringify(stages)); }, [stages]);

    // Atualiza Variáveis CSS de Tema
    useEffect(() => {
        if (settings.themeColor) {
            document.documentElement.style.setProperty('--primary', settings.themeColor);
            // Simples lógica para darken
            // Para um app real, usaríamos uma lib de cor. Aqui confiaremos no CSS filter ou opacidade se necessário
        }
    }, [settings.themeColor]);

    useEffect(() => {
        if (notification) {
            const timer = setTimeout(() => setNotification(null), 3000);
            return () => clearTimeout(timer);
        }
    }, [notification]);

    const showNotification = (message, type = 'success') => setNotification({ message, type });
    const addLog = (logEntry) => { setLogs([...logs, logEntry]); showNotification("Registro salvo com sucesso!"); };
    const updateLog = (updatedLog) => { setLogs(logs.map(l => l.id === updatedLog.id ? updatedLog : l)); showNotification("Registro atualizado!"); };
    const deleteLog = (id) => { setLogs(logs.filter(l => l.id !== id)); showNotification("Registro excluído."); };
    const saveRecipe = (recipe) => {
        if (recipe.id) { setRecipes(recipes.map(r => r.id === recipe.id ? recipe : r)); } 
        else { setRecipes([...recipes, { ...recipe, id: Date.now() }]); }
        setEditingRecipe(null); setView('recipes'); showNotification("Receita salva com sucesso!");
    };
    const deleteRecipe = (id) => { setRecipes(recipes.filter(r => r.id !== id)); showNotification("Receita excluída."); };

    const handleImportExcel = (file) => {
        const reader = new FileReader();
        reader.onload = (e) => {
            const bstr = e.target.result;
            try {
                const wb = XLSX.read(bstr, { type: 'binary' });
                const wsname = wb.SheetNames[0];
                const ws = wb.Sheets[wsname];
                const data = XLSX.utils.sheet_to_json(ws);
                if (data.length === 0) { showNotification("Planilha vazia.", 'error'); return; }

                const grouped = {};
                data.forEach(row => {
                    const rName = row['Receita'];
                    if(!rName) return;
                    if(!grouped[rName]) { grouped[rName] = { id: Date.now() + Math.random(), name: rName, line: row['Linha'] || 'Geral', sections: {}, ingredients: [] }; }
                    const section = row['Etapa'] || 'Massa';
                    if(!grouped[rName].sections[section]) { grouped[rName].sections[section] = { processLossPct: parseFloat(row['PerdaEtapa']) || 0, tolerancePct: parseFloat(row['Tolerancia']) || 10 }; }
                    grouped[rName].ingredients.push({ name: row['Ingrediente'], qty: parseFloat(row['Qtd']), unit: row['Unidade'] || 'kg', lossPct: parseFloat(row['PerdaIngrediente']) || 0, section: section });
                });
                setRecipes([...recipes, ...Object.values(grouped)]);
                showNotification(`${Object.values(grouped).length} receitas importadas!`);
            } catch (error) {
                showNotification("Erro ao ler arquivo. Verifique o formato.", 'error');
            }
        };
        reader.readAsBinaryString(file);
    };

    return (
        <div className="flex flex-col min-h-screen relative">
            <GlobalStyles />
            {notification && (<div className="fixed top-4 right-4 z-50 toast-enter no-print"><div className={`flex items-center gap-3 px-4 py-3 rounded-lg shadow-lg text-white ${notification.type === 'error' ? 'bg-red-500' : 'bg-emerald-600'}`}><Icon name={notification.type === 'error' ? 'X' : 'CheckCircle'} size={20} /><span className="font-medium">{notification.message}</span></div></div>)}

            <header className="bg-slate-900 text-white p-4 shadow-lg no-print">
                <div className="container mx-auto flex justify-between items-center">
                    <div className="flex items-center gap-3">
                        {settings.logo ? <img src={settings.logo} className="h-10 w-auto object-contain bg-white rounded p-1" alt="Logo" /> : <Icon name="ChefHat" className="text-primary" size={32} />}
                        <h1 className="text-xl font-bold tracking-tight">Controle de Rendimentos</h1>
                    </div>
                    <nav className="flex gap-4 text-sm font-medium">
                        <button onClick={() => setView('dashboard')} className={`hover:text-blue-300 transition-colors ${view === 'dashboard' ? 'text-primary' : 'text-slate-300'}`}>Painel</button>
                        <button onClick={() => setView('production')} className={`hover:text-blue-300 transition-colors ${view === 'production' ? 'text-primary' : 'text-slate-300'}`}>Produção</button>
                        <button onClick={() => setView('monitoring')} className={`hover:text-blue-300 transition-colors ${view === 'monitoring' ? 'text-primary' : 'text-slate-300'}`}>Monitoramento</button>
                        <button onClick={() => setView('recipes')} className={`hover:text-blue-300 transition-colors ${view === 'recipes' ? 'text-primary' : 'text-slate-300'}`}>Receitas</button>
                        <button onClick={() => setView('settings')} className={`hover:text-blue-300 transition-colors ${view === 'settings' ? 'text-primary' : 'text-slate-300'}`} title="Configurações"><Icon name="Settings" size={18} /></button>
                    </nav>
                </div>
            </header>

            <main className="flex-1 container mx-auto p-4 md:p-6">
                {view === 'dashboard' && <Dashboard setView={setView} />}
                {view === 'production' && <ProductionOrders recipes={recipes} lines={lines} onError={(msg) => showNotification(msg, 'error')} />}
                {view === 'monitoring' && <MonitoringView recipes={recipes} logs={logs} onSaveLog={addLog} onUpdateLog={updateLog} onDeleteLog={deleteLog} onError={(msg) => showNotification(msg, 'error')} />}
                {view === 'recipes' && !editingRecipe && <RecipeList recipes={recipes} lines={lines} onImport={handleImportExcel} onEdit={(r) => { setEditingRecipe(r); }} onCreate={() => setEditingRecipe({name: '', line: lines[0], baseYieldKg: 0, processLossPct: 0, ingredients: [{ name: '', qty: 0, unit: 'kg', lossPct: 0, section: stages[0] }]})} onDelete={deleteRecipe} />}
                {view === 'recipes' && editingRecipe && <RecipeEditor recipe={editingRecipe} lines={lines} stages={stages} onSave={saveRecipe} onCancel={() => setEditingRecipe(null)} onError={(msg) => showNotification(msg, 'error')} />}
                {view === 'settings' && <SettingsView lines={lines} setLines={setLines} stages={stages} setStages={setStages} settings={settings} setSettings={setSettings} onError={(msg) => showNotification(msg, 'error')} showNotification={showNotification} />}
            </main>

            <footer className="bg-slate-100 p-6 text-center text-slate-500 text-sm border-t border-slate-200 mt-auto no-print">
                <p className="italic font-serif text-slate-600 mb-2">"Não se gerencia o que não se mede, não se mede o que não se define, não se define o que não se entende e não há sucesso no que não se gerencia."</p>
                <p>© 2025 Sistema de Gestão de Produção</p>
            </footer>
        </div>
    );
}